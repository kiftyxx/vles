import{connect as e}from"cloudflare:sockets";const t="d232d32c885e21177f0fec6dd3b5ea0f112b7cff5ea7ade75b55767f414a324d",s={proxyIPs:[],bestDomains:[]},n=(new Set(["FUK","ICN","KIX","NRT","OKA"]),new Set(["AMS","CDG","FRA","LHR","DUB","MAD","MXP","ZRH","VIE","WAW","PRG","BRU","CPH","HEL","OSL","ARN","IST","ATH"]),new Set(["HKG","SIN","BKK","KUL","SGN","MNL","CGK","DEL","BOM","SYD","MEL","TPE","SEL"]),{HKG:"HK",TPE:"TW",NRT:"JP",KIX:"JP",FUK:"JP",OKA:"JP",ICN:"KR",SEL:"KR",SIN:"SG",LAX:"US",SJC:"US",SEA:"US",ORD:"US",ATL:"US",MIA:"US",DFW:"US",IAD:"US",EWR:"US",LHR:"UK",AMS:"NL",FRA:"DE",CDG:"FR"});let r={users:{},settings:s,websiteUrl:"",lastUpdate:0,ipToRegionMap:new Map};const a={HK:["hk","香港","hongkong","hong-kong"],TW:["tw","台湾","taiwan"],JP:["jp","日本","japan","tokyo","osaka","nrt","kix","ngo"],SG:["sg","新加坡","singapore"],US:["us","美国","usa","america","losangeles","newyork","seattle","dallas","miami"],KR:["kr","韩国","korea","seoul","icn","kor"],DE:["de","德国","germany","frankfurt","berlin"],UK:["uk","英国","london","britain","england"],EU:["eu","欧洲","europe","amsterdam","paris","ams","cdg","fra","lhr"]};function i(e){if(!e)return null;if(r.ipToRegionMap.has(e))return r.ipToRegionMap.get(e);const t=e.replace(/:\d+$/,"").replace(/^\[|\]$/g,"");if(r.ipToRegionMap.has(t))return r.ipToRegionMap.get(t);const s=e.toLowerCase();for(const[e,t]of Object.entries(a))for(const n of t)if(s.includes(n))return e;return null}export default{async fetch(t){const a=new URL(t.url);if("websocket"===t.headers.get("Upgrade")?.toLowerCase())return await async function(t){await o();const[a,c]=Object.values(new WebSocketPair);c.accept();const l=new URL(t.url);if(l.pathname.includes("%3F")){const e=decodeURIComponent(l.pathname),t=e.indexOf("?");-1!==t&&(l.search=e.substring(t),l.pathname=e.substring(0,t))}const d=l.searchParams.get("mode")||"auto",p=l.searchParams.get("proxyip"),u=t.cf?.colo||"",g=r.settings.proxyIPs||s.proxyIPs;let h=p,f=null,m=null,b=!1;return new ReadableStream({start(e){c.addEventListener("message",t=>{e.enqueue(t.data)}),c.addEventListener("close",()=>{if(f)try{f.close()}catch(e){}e.close()}),c.addEventListener("error",()=>{if(f)try{f.close()}catch(e){}try{e.error(Error("WebSocket error"))}catch(e){}});const s=t.headers.get("sec-websocket-protocol");if(s)try{const t=Uint8Array.from(atob(s.replace(/-/g,"+").replace(/_/g,"/")),e=>e.charCodeAt(0));e.enqueue(t.buffer)}catch(e){}}}).pipeTo(new WritableStream({async write(t){if(b&&m){try{await m.write(t)}catch(e){}return}if(f){try{const e=f.writable.getWriter();await e.write(t),e.releaseLock()}catch(e){}return}if(t.byteLength<24)return;const s=new DataView(t),a=function(e){const t=[];for(let e=0;e<256;e++)t.push((e+256).toString(16).substr(1));return[t[e[0]]+t[e[1]]+t[e[2]]+t[e[3]],t[e[4]]+t[e[5]],t[e[6]]+t[e[7]],t[e[8]]+t[e[9]],t[e[10]]+t[e[11]]+t[e[12]]+t[e[13]]+t[e[14]]+t[e[15]]].join("-").toLowerCase()}(new Uint8Array(t.slice(1,17)));if(!r.users[a]&&(await o(!0),!r.users[a]))return;const l=s.getUint8(0),p=s.getUint8(17),w=s.getUint8(18+p);if(1!==w&&2!==w)return;let y=19+p;const x=s.getUint16(y),k=s.getUint8(y+2);y+=3;let U="";if(1===k)U=`${s.getUint8(y)}.${s.getUint8(y+1)}.${s.getUint8(y+2)}.${s.getUint8(y+3)}`,y+=4;else if(2===k){const e=s.getUint8(y);y+=1,U=(new TextDecoder).decode(t.slice(y,y+e)),y+=e}else{if(3!==k)return;{const e=[];for(let t=0;t<8;t++)e.push(s.getUint16(y+2*t).toString(16));U=e.join(":"),y+=16}}const v=new Uint8Array([l,0]),S=t.slice(y);if(!h&&g.length>0&&(h=function(e,t){if(!e?.length)return null;const s=n[t];if(!s)return e[0];for(const t of e)if(i(t)===s)return t;return e[0]}(g,u)),2===w){if(53!==x)return;b=!0;let e=!1;const{readable:t,writable:s}=new TransformStream({transform(e,t){let s=0;for(;s<e.byteLength;){const n=new DataView(e.slice(s,s+2)).getUint16(0),r=e.slice(s+2,s+2+n);t.enqueue(r),s+=2+n}}});t.pipeTo(new WritableStream({async write(t){try{const s=await fetch("https://1.1.1.1/dns-query",{method:"POST",headers:{"Content-Type":"application/dns-message"},body:t});if(s.ok&&1===c.readyState){const t=new Uint8Array(await s.arrayBuffer()),n=new Uint8Array([...e?[]:v,t.length>>8,255&t.length,...t]);c.send(n),e=!0}}catch(e){}}})).catch(()=>{}),m=s.getWriter();try{await m.write(S)}catch(e){}return}let L=null;try{L=e({hostname:U,port:x}),await L.opened}catch(t){if(L=null,h&&"direct"!==d){const[t,s]=h.includes(":")?[h.split(":")[0],parseInt(h.split(":")[1])]:[h,443];try{L=e({hostname:t,port:s}),await L.opened}catch(e){L=null}}}if(!L)return;f=L;try{const e=L.writable.getWriter();await e.write(S),e.releaseLock()}catch(e){}let R=!1;L.readable.pipeTo(new WritableStream({write(e){1===c.readyState&&(R?c.send(e):(c.send(new Uint8Array([...v,...new Uint8Array(e)])),R=!0))},close(){1===c.readyState&&c.close()},abort(){1===c.readyState&&c.close()}})).catch(()=>{})}})).catch(()=>{}),new Response(null,{status:101,webSocket:a})}(t);if("GET"===t.method){if("/"===a.pathname){try{await o()}catch(e){}let e=r.websiteUrl||r.settings&&r.settings.subUrl||"https://example.com";e=(e||"https://example.com")+"",e.startsWith("http://")||e.startsWith("https://")||(e="https://"+e);const t=e.replace(/^https?:\/\//,"");return new Response(`<!DOCTYPE html><html class="light" lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>CFly 官网入口</title><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,400,0,0" rel="stylesheet"><script src="https://cdn.tailwindcss.com?plugins=forms,typography"><\/script><script>tailwind.config={darkMode:"class",theme:{extend:{colors:{primary:"#09090b","background-light":"#fff","background-dark":"#09090b"},fontFamily:{display:["Inter","system-ui","sans-serif"]},borderRadius:{DEFAULT:"0.5rem"}}}}<\/script><style>body{font-family:'Inter',sans-serif}.edge-network-bg{background-image:radial-gradient(circle at 2px 2px,rgba(0,0,0,0.05) 1px,transparent 0);background-size:40px 40px}.dark .edge-network-bg{background-image:radial-gradient(circle at 2px 2px,rgba(255,255,255,0.05) 1px,transparent 0)}.connecting-lines{position:absolute;inset:0;overflow:hidden;pointer-events:none;opacity:0.4}.line{position:absolute;background:linear-gradient(90deg,transparent,currentColor,transparent);height:1px;width:100%;opacity:0.1}.node{position:absolute;width:4px;height:4px;border-radius:50%;background:currentColor;box-shadow:0 0 8px currentColor;opacity:0.3}</style></head><body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 min-h-screen flex items-center justify-center relative overflow-hidden"><div class="absolute inset-0 edge-network-bg z-0"></div><div class="connecting-lines z-0 text-slate-400 dark:text-slate-600"><div class="line top-[20%] left-0 rotate-[15deg]"></div><div class="line top-[50%] left-0 rotate-[-10deg]"></div><div class="line top-[80%] left-0 rotate-[5deg]"></div><div class="node top-[22%] left-[15%]"></div><div class="node top-[48%] left-[45%]"></div><div class="node top-[75%] left-[85%]"></div><div class="node top-[10%] left-[70%]"></div></div><main class="relative z-10 w-full max-w-[380px] px-6"><div class="bg-white dark:bg-zinc-950 border border-zinc-200 dark:border-zinc-800 p-8 flex flex-col items-center text-center"><div class="mb-8"><span class="inline-flex items-center gap-1.5 px-2.5 py-0.5 rounded-full text-[12px] font-medium border border-zinc-200 dark:border-zinc-800 text-zinc-600 dark:text-zinc-400"><span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span></span>运行中</span></div><div class="mb-6 text-zinc-900 dark:text-zinc-100"><svg class="w-12 h-12" fill="none" height="48" viewBox="0 0 24 24" width="48" xmlns="http://www.w3.org/2000/svg"><path d="M22 2L11 13" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path><path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path></svg></div><h1 class="text-xl font-bold tracking-tight text-zinc-950 dark:text-zinc-50 mb-2">CFly 官网入口</h1><p class="text-sm text-zinc-500 dark:text-zinc-400 mb-10">点击下方按钮访问官网</p><a class="w-full group bg-primary dark:bg-zinc-50 text-white dark:text-zinc-950 h-11 flex items-center justify-center gap-2 font-medium transition-all hover:opacity-90 active:scale-[0.98]" href="${e}" target="_blank" rel="noopener noreferrer">进入官网<span class="material-symbols-outlined text-[18px]">north_east</span></a><div class="mt-10"><span class="text-[11px] font-mono tracking-wider text-zinc-400 dark:text-zinc-600 uppercase">${t}</span></div></div><button class="fixed bottom-6 right-6 p-2 rounded-full border border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-950 text-zinc-500 hover:text-zinc-950 dark:hover:text-zinc-50 transition-colors" onclick="document.documentElement.classList.toggle('dark')"><span class="material-symbols-outlined block dark:hidden">dark_mode</span><span class="material-symbols-outlined hidden dark:block">light_mode</span></button></main></body></html>`,{status:200,headers:{"Content-Type":"text/html; charset=utf-8"}})}await o();const e=r.users;for(const[s,n]of Object.entries(e))if(a.pathname.toLowerCase().includes(s.toLowerCase()))return await c(t,s,n)}return new Response("Not Found",{status:404})}};async function o(e=!1){const n=Date.now();if((e||!(n-r.lastUpdate<6e4))&&!(e&&n-r.lastUpdate<5e3))try{const e={"User-Agent":"Mozilla/5.0"};t&&(e.Authorization="Bearer "+t);const a=await fetch("https://ccfly.me/api/users",{headers:e,cf:{cacheTtl:0}});if(!a.ok)throw Error("HTTP "+a.status);const o=await a.json();if(o.users&&"object"==typeof o.users&&(r.users=o.users),o.settings&&(o.settings.websiteUrl?r.websiteUrl=o.settings.websiteUrl:o.settings.subUrl&&(r.websiteUrl=o.settings.subUrl)),o.settings&&"object"==typeof o.settings){const e={};e.proxyIPs=Array.isArray(o.settings.proxyIPs)&&o.settings.proxyIPs.length>0?o.settings.proxyIPs:o.settings.proxyIP?[o.settings.proxyIP]:s.proxyIPs,Array.isArray(o.settings.bestDomains)&&o.settings.bestDomains.length>0?(e.bestDomains=o.settings.bestDomains,r.ipToRegionMap.clear(),o.settings.bestDomains.forEach(e=>{const t=e.split("#"),s=t[0].trim(),n=i((t[1]?t[1].trim():"")||s);if(n){r.ipToRegionMap.set(s,n);const e=s.replace(/:\d+$/,"").replace(/^\[|\]$/g,"");r.ipToRegionMap.set(e,n)}})):e.bestDomains=s.bestDomains,r.settings=e}r.lastUpdate=n}catch(e){}}async function c(e,t,n){const a=function(e,t,n,a,i){const o=[],c="/?ed=2048",l=String.fromCharCode(118,108,101,115,115),d=(r.settings.bestDomains||s.bestDomains).filter(e=>"string"!=typeof e||!e.startsWith("___DISABLED___"));let p="telecom.1412.tech:443";if(d.length>0){let e=d[0].split("#")[0].trim();if(e.startsWith("["))p=e;else if(e.includes("[")&&e.includes("]"))p=e;else if((e.match(/:/g)||[]).length>1){const t=e.match(/^(.+):(\d+)$/);p=t&&!isNaN(t[2])?`[${t[1]}]:${t[2]}`:`[${e}]:443`}else p=e.includes(":")?e:e+":443"}const u=new URLSearchParams({encryption:"none",security:"tls",sni:e,fp:"chrome",type:"ws",host:e,path:c}),g=i?i.replace(/^https?:\/\//,""):"Not-Set";o.push(`${l}://${t}@${p}?${""+u}#${encodeURIComponent("Website-"+g)}`);const h=function(e){if(!e)return"Not-Activated";const t=new Date(e);return`${t.getFullYear()}-${(t.getMonth()+1+"").padStart(2,"0")}-${(t.getDate()+"").padStart(2,"0")}`}(a);return o.push(`${l}://${t}@${p}?${""+u}#${encodeURIComponent("Expire-"+h)}`),[...d].sort((e,t)=>{const s=e.includes("["),n=t.includes("[");return s&&!n?1:!s&&n?-1:0}).forEach((s,n)=>{const r=s.split("#");let a=r[0].trim();const i=r[1]?r[1].trim():null;let d,p;if(a.startsWith("["))d=a;else if(a.includes("[")&&a.includes("]"))d=a;else if((a.match(/:/g)||[]).length>1){const e=a.match(/^(.+):(\d+)$/);d=e&&!isNaN(e[2])?`[${e[1]}]:${e[2]}`:`[${a}]:443`}else d=a.includes(":")?a:a+":443";p=i||a.replace(/:\d+$/,"");const u=new URLSearchParams({encryption:"none",security:"tls",sni:e,fp:"chrome",type:"ws",host:e,path:c});o.push(`${l}://${t}@${d}?${""+u}#${encodeURIComponent(p)}`)}),o}(new URL(e.url).hostname,t,0,"object"==typeof n?n.expiry:null,r.websiteUrl||""),i=btoa(a.join("\n"));return new Response(i,{headers:{"Content-Type":"text/plain; charset=utf-8","Cache-Control":"no-store, no-cache, must-revalidate, max-age=0",Pragma:"no-cache"}})}